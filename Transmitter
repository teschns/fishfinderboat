# Transmitter (CircuitPython)

import time, board, busio, analogio, digitalio, adafruit_rfm69

# === Hardware Setup ===
joy_x = analogio.AnalogIn(board.A0)
joy_y = analogio.AnalogIn(board.A1)

mode_button = digitalio.DigitalInOut(board.D6)
mode_button.direction = digitalio.Direction.INPUT
mode_button.pull = digitalio.Pull.UP

# Radio (Feather RP2040 RFM69)
cs = digitalio.DigitalInOut(board.RFM_CS)
rst = digitalio.DigitalInOut(board.RFM_RST)
cs.switch_to_output(); rst.switch_to_output()

spi = busio.SPI(board.SCK, board.MOSI, board.MISO)
rfm = adafruit_rfm69.RFM69(spi, cs, rst, 915.0)
rfm.tx_power = 13

print("Transmitter ready")

def read_joystick(pin):
    return int((pin.value / 65535) * 255)

last_button_state = True
mode_flag = 0

while True:
    x = read_joystick(joy_x)
    y = read_joystick(joy_y)
    b = mode_button.value

    # Toggle mode on button press
    if last_button_state and not b:
        mode_flag ^= 1
    last_button_state = b

    msg = f"{y},{x},{mode_flag}"
    rfm.send(bytes(msg, "utf-8"))
    print("Sent:", msg)
    time.sleep(0.05)
